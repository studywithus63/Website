---
export const prerender = false;
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const { slug } = Astro.params;
const posts = await getCollection('blog');
const post = posts.find(p => p.data.slug === slug);

if (!post) {
  return new Response(null, { status: 404 });
}

// Ensure heroImage is an array
const heroImages = Array.isArray(post.data.heroImage) ? post.data.heroImage : [post.data.heroImage];
---

<BaseLayout title={`Edit: ${post.data.title}`}>
  <main class="bg-gray-50 dark:bg-gray-900">
    <section class="py-8 px-4 mx-auto max-w-2xl lg:py-16">
      <h2 class="mb-4 text-xl font-bold text-gray-900 dark:text-white text-center">Edit "{post.data.title}"</h2>
      <form id="edit-post-form" data-slug={post.data.slug}>
        <div class="grid gap-4 sm:grid-cols-2 sm:gap-6">
          <div class="sm:col-span-2">
            <label for="title" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Post Title</label>
            <input type="text" name="title" id="title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" value={post.data.title} required>
          </div>
          <div class="sm:col-span-2">
            <label for="slug" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Slug</label>
            <input type="text" name="slug" id="slug" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" value={post.data.slug} required>
          </div>
          <div class="sm:col-span-2">
            <label for="author" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Author Name</label>
            <input type="text" name="author" id="author" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" value={post.data.author} required>
          </div>
          <div class="sm:col-span-2">
            <label for="description" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Meta Description</label>
            <textarea id="description" name="description" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500">{post.data.description}</textarea>
          </div>
          <div class="sm:col-span-2">
            <label for="tableOfContents" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Table of Contents</label>
            <textarea id="tableOfContents" name="tableOfContents" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500">{post.data.tableOfContents || ''}</textarea>
          </div>
          <div class="sm:col-span-2">
            <label for="heroImage" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Hero Image URLs (one per line)</label>
            <textarea name="heroImage" id="heroImage" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500">{heroImages.join('\n')}</textarea>
          </div>
           <div class="sm:col-span-2">
            <label for="imageAlt" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Hero Image Alt Text</label>
            <input type="text" name="imageAlt" id="imageAlt" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" value={post.data.imageAlt} required>
        </div>
          <div class="sm:col-span-2">
            <div class="flex justify-between items-center mb-2">
              <label for="content" class="text-sm font-medium text-gray-900 dark:text-white">Main Content (Markdown supported)</label>
            </div>
            <textarea id="content" name="content" rows="10" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500">{post.body}</textarea>
          </div>

        </div>

        <div id="form-message" class="mt-4 text-center font-medium"></div>
        <div class="flex items-center space-x-4 mt-6">
          <button type="submit" id="submit-btn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Update Post</button>
          <a href="/admin" class="text-gray-600 inline-flex items-center hover:text-white border border-gray-300 hover:bg-gray-400 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:border-gray-500 dark:text-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-900">Cancel</a>
        </div>
      </form>
    </section>
  </main>
</BaseLayout>

<style>
  #form-message.success { color: #16a34a; }
  #form-message.error { color: #dc2626; }
</style>

<script>
  const form = document.getElementById('edit-post-form');
  const messageDiv = document.getElementById('form-message');
  const submitButton = document.getElementById('submit-btn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitButton.disabled = true;
    submitButton.textContent = 'Updating...';
    messageDiv.textContent = '';

    const formData = new FormData(form);
    const slug = form.dataset.slug;

    // Convert heroImage textarea to an array
    const heroImageValue = formData.get('heroImage');
    formData.delete('heroImage'); // Remove original heroImage
    const heroImageArray = heroImageValue.split('\n').filter(url => url.trim() !== '');
    heroImageArray.forEach(url => {
      formData.append('heroImage[]', url);
    });

    try {
      const response = await fetch(`/api/update-post?slug=${slug}` , {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (response.ok) {
        messageDiv.textContent = 'Post updated successfully! Redirecting...';
        messageDiv.className = 'success';
        
        setTimeout(() => {
          // Redirect to the new slug if it changed
          const newSlug = formData.get('slug');
          if (newSlug && newSlug !== slug) {
            window.location.href = `/blog/${newSlug}`;
          } else {
            window.location.href = '/admin';
          }
        }, 2000);

      } else {
        throw new Error(result.message || 'An unknown error occurred.');
      }

    } catch (error) {
      messageDiv.textContent = `Error: ${error.message}`;
      messageDiv.className = 'error';
      submitButton.disabled = false;
      submitButton.textContent = 'Update Post';
    }
  });
</script>